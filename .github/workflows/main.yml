name: Node.js CI

on:
  push:
    branches: [ $default-branch ]
  pull_request:
    branches: [ $default-branch ]

jobs:
  compile:
    name: Verify compilation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - uses: actions/cache@v2
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - run: yarn install --frozen-lockfile --prefer-offline
      - run: yarn compile
  lint:
    name: Lint code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - uses: actions/cache@v2
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - run: yarn install --frozen-lockfile --prefer-offline
      - run: yarn lint
  test:
    name: Run tests (Node.js)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x, 15.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - uses: actions/cache@v2
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - run: yarn install --frozen-lockfile --prefer-offline
      - run: yarn test
      - name: Codecov
        uses: codecov/codecov-action@v1

# FROM TRAVIS CI:

# - /^v\d+\.\d+(\.\d+)?(-\S*)?$/ # Allow vX.X.X tags

# - stage: deploy
#   if: type = push AND tag IS present
#   name: Deploy to npm
#   node_js: lts/*
#   script:
#     - yarn compile
#     - echo "Deploying to npm..."
#   deploy:
#     provider: npm
#     skip_cleanup: true
#     email: wes@sparksuite.com
#     api_key:
#       secure: "B/jeQyxOiyRH8+9IzheW0yA3iBFePR7ox6l5xQqYhQcTEh4puW4wdjXL1GHvZjnS3XF5Um1I6Jftwt71YeYl+oggxqPEPrTdQsh07ByDF1rfTzRgRCAcgOIm1skqKApKzP1/3ZoHVNT84TZlA4t959cTDNOHiun6uZmk/gXhGT1CnORaEvD6l2PCC3puDQGMcbZRFe0ERWOFfrG0F9mAt5m3NJZcnYcqCX+xijInnya0J1+RDgOJseyIzKB3qiRWtdgTN2vSJShTSFFO+UnUCDRBqb6zq+cQrKXhUhqvnKXfv3DwmCRZ85fnlv1VU0JSLoIWUgGmcYrOWIKQd9yU97p1LRvERgoKVYIdV6khaznryubg0jmBA0A4p6BXwH7lLu5aRFmHihRyZRinpS4J8LogXqSA43RwGUV0NsVRCqvdE26gzqdytG76feFHncqY9Sl4vTt6Ow9eitc0QE0dMrhzANeq5NGyoLTzgassZsCImzJMzSac6RofZ5Sab+NWxmqBbgzQvCLzIjW0uMIpLq3p3qZt/g1rmi2hKyU4PLqUG4BXIys5O17i3b/m0sljnyENJ/8DBrWe2Shhiis1xieZKOiEC1q/dT5Qmn9VWDlm19TFDYNtBNj/K8OTY4LBwmO9QupDXNcUWlwXybgW6ez14bphCfGIJ2N8N9N5qKQ="
#     on:
#       tags: true